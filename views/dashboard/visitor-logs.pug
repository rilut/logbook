extends ../layout

block content
  .page-header
    include partials/header
    h3 Dashboard

  p.lead Guest Logs
  table.table.table-striped.table-hover.table-bordered(id="logs-table")
    thead
      th.text-center.col-sm-3 Name
      th.text-center.col-sm-1 DOB
      th.text-center.col-sm-1 NRIC/FIN
      th.text-center.col-sm-2 Membership No
      th.text-center.col-sm-2 Membership/Expiry
      th.text-center.col-sm-1 Login
      th.text-center.col-sm-1 Logout
      th.text-center.col-sm-1 Successful?
      th.text-center.col-sm-1 Action
    //tr
    //  td Giacomo Gullizoni
    //  td 01/02/1999
    //  td S1234567X
    //  td 1234567
    //  td 02/02/2018
    //  td 02/02/2017 19:00
    //  td 02/02/2017 21:00
    //  td.text-center
    //    input(type="checkbox", value="")
    //  td
    //    button.btn.btn-link(type='submit')
    //      i.fa.fa-trash
    // .row
    // nav.text-center(aria-label="Page navigation")
    //   ul.pagination
    //     li
    //       a(href="#", aria-label="Previous")
    //         span(aria-hidden="true") «
    //     li
    //       a(href="#") 1
    //     li
    //       a(href="#") 2
    //     li
    //       a(href="#") 3
    //     li
    //       a(href="#") 4
    //     li
    //       a(href="#") 5
    //     li
    //       a(href="#", aria-label="Next")
    //         span(aria-hidden="true") »

    .btn-export-excel
      a(href='/logs/csv')
        button.btn.btn-success(type='submit')
          i.fa.fa-file-excel-o
          | Export All Logs to Excel File

  link(rel='stylesheet', href='//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css')
  link(rel='stylesheet', href='//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css')

  script(src='//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js')
  script(src='//cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.0/moment.min.js')
  script(src='//cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js')

  script.
    $(document).ready(function () {
      
      $('#logs-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": "logs/datatable",
        "columns": [
          {"data": "visitor.name"},
          {"data": "visitor.dob", "searchable": false},
          {"data": "visitor.nric"},
          {"data": "visitor.membershipId"},
          {"data": "visitor.membershipExpiry", "searchable": false},
          {"data": "timeIn"},
          {"data": "timeOut"},
          {"data": "loginSuccessful"},
          {"data": "_id", "searchable": false, 'orderable': false}
        ],
        "order": ["5", "desc"],
        "columnDefs": [ 
          { 
            "targets": 1,
            "render": (data) => moment(data).format("DD/MM/YYYY")
          },
          { 
            "targets": 4,
            "render": (data) => moment(data).format("DD/MM/YYYY")
          },
          { 
            "targets": 5,
            "render": (data) => moment(data).format("DD/MM/YYYY, h:mm A")
          },
          { 
            "targets": 6,
            "render": (data) => moment(data).format("DD/MM/YYYY, h:mm A")
          },
          { 
            "targets": 7,
            "render": (data) =>  data ? 'Success' : 'Fail'
          },
          {
            "targets": 8,
            "render": (data) => `<button class="editable btn btn-primary" data-id="${data}">Edit</button>`
          }
        ],
      });

      $('#logs-table').on('draw.dt', function () {
         new EditableDatatable({
            className: 'editable',
            fields: [
              {
                target: 5,
                type: 'datetime',
                name: 'timeIn'
              },
              {
                target: 6,
                type: 'datetime',
                name: 'timeOut'
              },
              {
                target: 7,
                type: 'boolean',
                name: 'loginSuccessful',
                labels: ['Success','Fail']
              }
            ],
            onSave: (data) => {
              $.ajax({
                type: "PUT",
                url: `/logs/${data.id}`,
                data,
                dataType: "json",
                success: function (res) {
                  location.reload();
                }
              });
            }
          })
      });

    });

    class EditableDatatable {
      constructor(options) {
        this.className = options.className;
        this.fields = options.fields;
        this.fieldsIds = options.fields.map(el => el.target)
        this.onSave = options.onSave

        this.initEditable()
      }

      initEditable () {
        const buttons = $(`.${this.className}`);
        
        $.each(buttons, (index, button) => {
          $(button).off("click")

          $(button).click((s) => {
            const columns = $(button).parent().siblings();
            const id = $(button).data('id');

            $.each(columns, (colIndex, col) => {

              if(this.fieldsIds.indexOf(colIndex) !== -1) {
                const field = this.fields.find(el => el.target === colIndex);
                let value = $(col).html();

                switch(field.type) {
                  case 'datetime': 
                    $(col).html(`<input class="form-control" name="${field.name}-${id}" id="${field.name}-${id}" style="width:170px"/>`);
                    $(`#${field.name}-${id}`).datetimepicker({defaultDate: new Date(value), format : "DD/MM/YYYY h:mm A"});
                  break;
                  case 'boolean':
                    value = value === field.labels[0];
                    $(col).html(`
                      <div class="radio"> <label><input type="radio" ${value} ${value ? 'checked': ''} value="true" name="${field.name}-${id}">${field.labels[0]}</label> </div>
                      <div class="radio"> <label><input type="radio" ${value ? '': 'checked'} name="${field.name}-${id}" value="false">${field.labels[1]}</label> </div>`);
                  break;
                }
              }

            });

            $(button).off("click")
            $(button).attr('class', 'btn btn-success');
            $(button).html('Save');

            $(button).click((b) => {
              let values = { id };

              $.each(columns, (colIndex, col) => {

                if(this.fieldsIds.indexOf(colIndex) !== -1) {
                  const field = this.fields.find(el => el.target === colIndex);

                  switch(field.type) {
                    case 'datetime': 
                      const val = $(`input[name="${field.name}-${id}"]`).val();
                      values = Object.assign(values, {[field.name]: new Date(val)})
                      $(col).html(moment(new Date(val)).format("DD/MM/YYYY, h:mm A"));
                    break;
                    case 'boolean':
                      const val2 = $(`input[name="${field.name}-${id}"]:checked`).val();
                      values = Object.assign(values, {[field.name]: val2 === 'true'})
                      $(col).html(val2 === 'true' ? field.labels[0] : field.labels[1]);
                    break;
                  }
                }

              });

              $(button).off("click")
              $(button).attr('class', `${this.className} btn btn-primary`);
              $(button).html('<i class="fa fa-spinner fa-pulse fa-small fa-fw"></i><span>Saving</span>');

              this.onSave(values);
              //- this.initEditable()
            })
          })

        })
      }

    }
     