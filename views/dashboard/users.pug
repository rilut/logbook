extends ../layout

block content
  .page-header
    include partials/header
    h3 Dashboard

  p.lead Users
  table.table.table-striped.table-hover.table-bordered(id="users-table")
    thead
      th.text-center.col-sm-4 Name
      th.text-center.col-sm-3 Email
      th.text-center.col-sm-2 Role
      th.text-center.col-sm-2 Reset Password

  p.lead Add a User
  form.form-horizontal(method='POST', action='/users')
    input(type='hidden', name='_csrf', value=_csrf)
    .form-group
      label.col-sm-3.control-label(for='name') Name*
      .col-sm-7
        input.form-control(
          type='text',
          name='name',
          id='name',
          placeholder='Name',
          autofocus,
          required
        )
    .form-group
      label.col-sm-3.control-label(for='email') Email*
      .col-sm-7
        input.form-control(
          type='email',
          name='email',
          id='email',
          placeholder='Email',
          autofocus,
          required
        )
    .form-group
      label.col-sm-3.control-label(for='role') Role*
      .col-sm-7
        select.form-control(name='role', required)
          option(value='Supervisor') Supervisor
          option(value='Operator') Operator
    .form-group
      .col-sm-offset-3.col-sm-7
        button.col-sm-3.btn.btn-primary(type='submit') Submit

  form(method='POST', action='/forgot', id='reset-form')
    input(type='hidden', name='_csrf', value=_csrf)
    input(type='hidden', name='email', id='reset-email')
    input(type='hidden', name='type', value='manage')

  link(rel='stylesheet', href='//cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css')
  script(src='//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js')
  script.
    $(document).ready(function () {
      var table = $('#users-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": "users/datatable",
        "columns": [
          {"data": "name"},
          {"data": "email"},
          {
            "data": "role",
            "render": function (data, type, full, meta) {
              var roles = ['Administrator', 'Supervisor', 'Operator'];
              var select = '<select class="form-control roles">';
              roles.forEach(function (val) {
                var selected = full.role === val ? 'selected' : '';
                select += '<option ' + selected + '>' + val + '</option>'
              })
              select += '</select>'
              return select;
            }
          },
          {
            "className": "text-center",
            "defaultContent": "<button type='button' class='btn btn-default reset-password'>Reset</button>"
          }
        ],
        "order": ["0", "asc"]
      });

      $('#users-table tbody').on('click', 'td button.reset-password', function () {
        var tr = $(this).closest('tr');
        var email = table.row(tr).data().email;
        $('#reset-email').val(email);
        $('#reset-form').submit();
      });

      $('#users-table tbody').on('change', 'td select.roles', function () {
        var tr = $(this).closest('tr');
        var id = table.row(tr).data()._id;
        var role = $(this).val();
        console.log(role);

        $.ajax({
          type: "PUT",
          url: "/users/" + id + "/roles",
          data: { role },
          dataType: "json",
          success: function (res) {
            location.reload();
          }
        });
      });
    });

